{% extends "./base.html" %}
{% block scripts %}
    <script src="/static/game-details.js"></script>
{% endblock %}
{% load tags %}
{% block content %}
    <div class="content-box">
        <div class="leftpane">
            <h1 class="game-title">{{ game.title }}</h1>
        </div>
        <div class="leftpane">
            <div class="game-description">
                {{ markdown|safe }}
            </div>
        </div>
        <div class="leftpane">
            <div class="game-auxinfo">
                Игра добавлена {{ added_date }}
                пользователем {{ game.added_by }}.
            </div>
            {% if last_edit_date %}
                <div class="game-auxinfo">
                    Последнее редактирование {{ last_edit_date }}.
                </div>
            {% endif %}
        </div>
        <div class="leftpane">
            {% if user.is_authenticated or comments %}
                <hr>
            {% endif %}
            {% if user.is_authenticated or comments %}
                <form class="comment-input" id="reply-1" action="{% url 'comment_game' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="game_id" value="{{game.id}}" />
                    <input placeholder="Заголовок комментария" type="text" name="subject" style="display: none;"/>
                    <textarea placeholder="Добавить комментарий... (поддерживается markdown)" name="text" required></textarea>
                    <input type="submit" value="Отправить" style="display: none;"/>
                </form>
                <form class="comment-input" id="reply-2" action="{% url 'comment_game' %}" method="post" style="display: none;"/>
                    {% csrf_token %}
                    <input type="hidden" name="parent"/>
                    <input type="hidden" name="game_id" value="{{game.id}}" />
                    <input placeholder="Заголовок комментария" type="text" name="subject"/>
                    <textarea class="active" placeholder="Добавить комментарий... (поддерживается markdown)" name="text" required></textarea>
                    <input type="submit" value="Отправить"/>
                </form>
            {% endif %}
            {% for c in comments %}
                <div class="comment-box {% if c.parent_id %}level2{% endif %}" data-id="{{ c.id }}">
                <div class="comment-header">
                    {% if c.subj %}<span class="comment-subj">{{ c.subj }}</span>{% endif %}
                    <span class="comment-nick">
                        {{ c.username }}
                        {% if c.furl %}
                            (<a href="{{ c.furl }}">c.fsite</a>)
                        {% endif %}
                    </span>
                </div>
                <div class="comment-body">{{ c.text|safe }}</div>
                <div class="comment-footer">
                    <span class="comment-time">{{ c.created }}</span>
                    {% if user.is_authenticated %} {# TODO depend on perm #}
                        | <a class="reply-link" href="#">Ответить</a>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
    {%if release_date %}
    <div class="rightpane">
        <table>
            <tr>
                <td class="prop-category">
                    Дата выхода:
                </td>
                <td class="prop-value">
                    {{ release_date }}
                </td>
            </tr>
        </table>
        <hr>
    </div>
{% endif %}
{% if authors %}
    <div class="rightpane">
        <table>
            {% for role in authors %}
                {% for author in role.authors %}
                    <tr>
                        <td class="prop-category">
                            {% if forloop.first %}
                                {{ role.role.title }}:
                            {% endif %}
                        </td>
                        <td class="prop-value">
                            {{ author.name }}
                        </td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </table>
        <hr>
    </div>
{% endif %}
{% if tags %}
    <div class="rightpane">
        <table>
            {% for cat in tags %}
                {% for tag in cat.tags %}
                    <tr>
                        <td class="prop-category">
                            {% if forloop.first %}
                                {{ cat.category.name }}:
                            {% endif %}
                        </td>
                        <td class="prop-value">
                            {{ tag.name }}
                        </td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </table>
    </div>
{% endif %}
<div class="rightpane">
    <hr />
    {% if votes.played_count == 0 %}
        <div class="prop-comment">
            В эту игру никто не играл.
        </div>
    {% else %}
        <table>
            <tr>
                <td class="prop-category">
                    Рейтинг:
                </td>
                <td class="prop-value">
                    {% for x in votes.stars %}
                        <img src="/static/duck{{x}}.png" />
                    {% endfor %}
                    ({{ votes.avg_rating }})
                </td>
            </tr>
            <tr>
                <td></td>
                <td class="prop-category">
                    ({{ votes.played_count|rupl:"оценка,оценки,оценок" }})
                </td>
            </tr>
            <tr>
                <td class="prop-category">
                    Среднее время игры:
                </td>
                <td class="prop-value">
                    {{ votes.played_hours|rupl:"час,часа,часов" }}
                    {{ votes.played_mins|rupl:"минута,минуты,минут" }}
                </td>
            </tr>
            <tr>
                <td class="prop-category">
                    Время прохождения:
                </td>
                <td class="prop-value">
                    {{ votes.finished_hours|rupl:"час,часа,часов" }}
                    {{ votes.finished_mins|rupl:"минута,минуты,минут" }}
                </td>
            </tr>
            <tr>
                <td></td>
                <td class="prop-category">
                    ({{ votes.finished_count|rupl:"человек,человека,человек" }})
                </td>
            </tr>
        </table>
    {% endif %}
    {% if user.is_authenticated %}
        {% if votes.user_played %}
            <div class="prop-comment">
                (ваша оценка: {{ votes.user_score }},
                {% if votes.user_finished %}
                    вы прошли игру за
                {% else %}
                    вы играли в эту игру
                {% endif %}
                {{votes.user_hours}} ч.
                {{votes.user_mins}} м.)
            </div>
            <button id="voting_button">Изменить</button>
        {% else %}
            {% if votes.played_count == 0 %}
                <button id="voting_button">Я в это играло</button>
            {% else %}
                <button id="voting_button">Я в это тоже играло</button>
            {% endif %}
        {% endif %}
        <form id="voting_form" style="display: none;" method="post"
            action="{% url 'vote_game' %}">
            <div class="prop-value">Оценка:</div>
            <input type="radio" name="score" id="score1" value="1"
            {% if votes.user_score == 1 %}checked{% endif %}
            required/>
            <label for="score1">
                <img src="/static/duck10.png" />
                <img src="/static/duck0.png" />
                <img src="/static/duck0.png" />
                <img src="/static/duck0.png" />
                <img src="/static/duck0.png" />
                &mdash; не понравилось
            </label><br>
            <input type="radio" name="score" id="score2" value="2"
            {% if votes.user_score == 2 %}checked{% endif %}
            required/>
            <label for="score2">
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck0.png" />
                <img src="/static/duck0.png" />
                <img src="/static/duck0.png" />
                &mdash; нормально
            </label><br>
            <input type="radio" name="score" id="score3" value="3"
            {% if votes.user_score == 3 %}checked{% endif %}
            required/>
            <label for="score3">
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck0.png" />
                <img src="/static/duck0.png" />
                &mdash; понравилось
            </label><br>
            <input type="radio" name="score" id="score4" value="4"
            {% if votes.user_score == 4 %}checked{% endif %}
            required/>
            <label for="score4">
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck0.png" />
                &mdash; очень понравилось
            </label><br>
            <input type="radio" name="score" id="score5" value="5"
            {% if votes.user_score == 5 %}checked{% endif %}
            required/>
            <label for="score5">
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                <img src="/static/duck10.png" />
                &mdash; изумительная игра!
            </label><br>
            Я играло в эту игру<br>
            <span class="vote-timeselect hours">0</span>
            <span class="vote-timeselect hours">1</span>
            <span class="vote-timeselect hours">2</span>
            <span class="vote-timeselect hours">3</span>
            <span class="vote-timeselect hours">4</span>
            <span class="vote-timeselect hours">5</span>
            <input id="hours" type="number" min="0" max="9999"
            name="hours" value="{{votes.user_hours}}" required>
            <script type="text/javascript">
            $('.vote-timeselect.hours').click(function(event) {
            $('#hours').val($(this).text());
            })
            </script>
            часов и<br>
            <span class="vote-timeselect minutes">0</span>
            <span class="vote-timeselect minutes">5</span>
            <span class="vote-timeselect minutes">10</span>
            <span class="vote-timeselect minutes">15</span>
            <span class="vote-timeselect minutes">20</span>
            <span class="vote-timeselect minutes">30</span>
            <span class="vote-timeselect minutes">45</span>
            <input id="minutes" type="number" min="0" max="59"
            name="minutes" value="{{votes.user_mins}}" required>
            <script type="text/javascript">
            $('.vote-timeselect.minutes').click(function(event) {
            $('#minutes').val($(this).text());
            })
            </script>
            минут.<br>
            <input type="checkbox" name="finished" id="scoref"
            {% if votes.user_finished %}checked{% endif %}/>
            <label for="scoref">Я прошло эту игру до конца.</label>
            <br><br><input type="submit" value="Отправить мой голос" />
            {% csrf_token %}
            <input type="hidden" name="game_id" value="{{ game.id }}" />
        </form>
        <script type="text/javascript">
        $('#voting_button').click(function() {
        $('#voting_button').hide();
        $('#voting_form').show();
        });
        </script>
    {% endif %}
</div>
{% if tags %}
    <div class="rightpane">
        <hr>
        <table>
            {% for link in links %}
                {% for url in link.urls %}
                    <tr>
                        <td class="prop-category">
                            {% if forloop.first %}
                                {{ link.category.title }}:
                            {% endif %}
                        </td>
                        <td class="prop-value">
                            <a href="{{ url.url.original_url }}">
                                {{ url.description }}
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </table>
    </div>
{% endif %}
<div style="clear: both;"></div>
</div>
{% endblock %}