{% extends "./base.html" %}
{% load tags %}
{% load static %}
{% block scripts %}
    {% if media %}
    <link rel="stylesheet" type="text/css" href="{% static 'slick/slick.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'slick/slick-theme.css' %}"/>
    <script type="text/javascript" src="{% static 'slick/slick.min.js' %}"></script>
    {% endif %}
    <script src="/static/game-details.js"></script>
{% endblock %}
{% block content %}
    <div class="content-box-outer">
        <div class="content-moder-line">
            {% if edit_perm %}
                <a href="{% url 'edit_game' game.id %}" title="Редактировать">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                        <path d="M27 0c2.761 0 5 2.239 5 5 0 1.126-0.372 2.164-1 3l-2 2-7-7 2-2c0.836-0.628 1.874-1 3-1zM2 23l-2 9 9-2 18.5-18.5-7-7-18.5 18.5zM22.362 11.362l-14 14-1.724-1.724 14-14 1.724 1.724z">
                        </path>
                    </svg>
                </a>
            {% endif %}
            {% if delete_perm %}
                <a href="#" title="Удалить">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
                        <path d="M64 160v320c0 17.6 14.4 32 32 32h288c17.6 0 32-14.4 32-32v-320h-352zM160 448h-32v-224h32v224zM224 448h-32v-224h32v224zM288 448h-32v-224h32v224zM352 448h-32v-224h32v224z">
                        </path>
                        <path d="M424 64h-104v-40c0-13.2-10.8-24-24-24h-112c-13.2 0-24 10.8-24 24v40h-104c-13.2 0-24 10.8-24 24v40h416v-40c0-13.2-10.8-24-24-24zM288 64h-96v-31.599h96v31.599z">
                        </path>
                    </svg>
                </a>
            {% endif %}
        </div>
        <div class="content-box-inner">
            <div class="leftpane">
                <div class="game-header">
                    <h1>{{ game.title }}</h1>
                    <div class="game-info">
                    {% if authors %}
                        {% if authors|length == 1 %}Автор:{% else %}Авторы:{% endif %}
                        {% for x in authors %}
                            <span class="gameinfo-author">{{ x.name }}{% if not forloop.last %}, {% endif %}</span>
                        {% endfor %}
                    {% endif %}
                    </div>
                    {% if online %}
                    <div class="game-info">
                        Играть:
                        {% for x in online %}
                            {% if x.category.symbolic_id == 'play_in_interpreter' %}
                                <a href="{% url 'play_in_interpreter' gameurl_id=x.pk %}" class="button-like">{{x.description}}</a>
                            {% else %}
                                <span class="button-like">
                                    <a {% if x.url.is_broken %}title="Битая ссылка!"{% endif %} href="{{ x.GetRemoteUrl }}">
                                        {% if x.url.is_broken %}
                                            <img src="{% static 'brokenlink.svg' %}"/>
                                        {% endif %}
                                        {{x.description}}
                                    </a>
                                </span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if download %}
                    <div class="game-info">
                        Скачать:
                        {% for x in download %}
                            <span class="button-like">
                                <a {% if x.url.is_broken %}title="Битая ссылка!"{% endif %} href="{{ x.GetRemoteUrl }}" download>
                                    {% if x.url.is_broken %}
                                        <img src="{% static 'brokenlink.svg' %}"/>
                                    {% endif %}
                                    {{x.description}}
                                </a>
                                {% if x.HasLocalUrl %}
                                    <a title="Скачать резервную копию" href="{{ x.GetLocalUrl }}"><img src="{% static 'localbackup.svg' %}"/></a>
                                {% endif %}
                            </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% if media %}
            <div class="leftpane slider-container">
                <div class="largeslider">
                    {% for x in media %}
                        <div class="slideritem-outer">
                        <div class="slideritem-inner">
                            {% if x.type == 'img' %}
                            <img src="{{ x.img }}"/>
                            {% elif x.type == 'youtube' %}
                                <iframe type="text/html" width="480" height="270"
                                    src="https://www.youtube.com/embed/{{ x.id }}?origin={{ request.path|urlencode }}"
                                    frameborder="0" marginwidth="0"></iframe>
                            {% else %}
                            <img src="{% static 'noposter.png' %}"/>
                            {% endif %}
                        </div>
                        </div>
                    {% endfor %}
                </div>
                {% if media|length > 1 %}
                <div class="smallslider">
                    {% for x in media %}
                        {% if x.type == 'img' %}
                        <img class="slideritem" src="{{ x.img }}"/>
                        {% elif x.type == 'youtube' %}
                        <div class="videothumb slideritem">
                            <img src="https://img.youtube.com/vi/{{ x.id }}/default.jpg"/>
                            <h2>&#9654;</h2>
                        </div>
                        {% else %}
                        <img class="slideritem" src="{% static 'noposter.png' %}"/>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            <div class="leftpane">
                <div class="game-description">
                    {{ markdown|safe }}
                </div>
            </div>
            <div class="leftpane">
                <div class="game-auxinfo">
                    Игра добавлена {{ added_date }}.
                </div>
                {% if last_edit_date %}
                    <div class="game-auxinfo">
                        Последнее редактирование {{ last_edit_date }}.
                    </div>
                {% endif %}
            </div>
            <div class="leftpane">
                {% if user.is_authenticated or comments %}
                    <hr>
                {% endif %}
                {% if user.is_authenticated or comments %}
                    <form class="comment-input" id="reply-1" action="{% url 'comment_game' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="game_id" value="{{game.id}}" />
                        <input placeholder="Заголовок комментария" type="text" name="subject" style="display: none;"/>
                        <textarea placeholder="Добавить комментарий... (поддерживается markdown)" name="text" required></textarea>
                        <input type="submit" value="Отправить" style="display: none;"/>
                    </form>
                    <form class="comment-input" id="reply-2" action="{% url 'comment_game' %}" method="post" style="display: none;"/>
                        {% csrf_token %}
                        <input type="hidden" name="parent"/>
                        <input type="hidden" name="game_id" value="{{game.id}}" />
                        <input placeholder="Заголовок комментария" type="text" name="subject"/>
                        <textarea class="active" placeholder="Добавить комментарий... (поддерживается markdown)" name="text" required></textarea>
                        <input type="submit" value="Отправить"/>
                    </form>
                {% endif %}
                {% for c in comments %}
                    <div class="comment-box {% if c.parent_id %}level2{% endif %}" data-id="{{ c.id }}">
                        <div class="comment-header">
                            {% if c.subj %}<span class="comment-subj">{{ c.subj }}</span>{% endif %}
                            <span class="comment-nick">
                                {{ c.username }}
                                {% if c.furl %}
                                    (<a href="{{ c.furl }}">c.fsite</a>)
                                {% endif %}
                            </span>
                        </div>
                        <div class="comment-body">{{ c.text|safe }}</div>
                        <div class="comment-footer">
                            <span class="comment-time">{{ c.created }}</span>
                            {% if comment_perm %}
                                | <a class="reply-link" href="#">Ответить</a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            {%if release_date %}
            <div class="rightpane">
                <table>
                    <tr>
                        <td class="prop-category">
                            Дата выхода:
                        </td>
                        <td class="prop-value">
                            {{ release_date }}
                        </td>
                    </tr>
                </table>
                <hr>
            </div>
        {% endif %}
        {% if participants %}
            <div class="rightpane">
                <table>
                    {% for role in participants %}
                        {% for author in role.items %}
                            <tr>
                                <td class="prop-category">
                                    {% if forloop.first %}
                                        {{ role.category.title }}:
                                    {% endif %}
                                </td>
                                <td class="prop-value">
                                    {{ author.name }}
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </table>
                <hr>
            </div>
        {% endif %}
        {% if tags %}
            <div class="rightpane">
                <table>
                    {% for cat in tags %}
                        {% for tag in cat.items %}
                            <tr>
                                <td class="prop-category">
                                    {% if forloop.first %}
                                        {{ cat.category.name }}:
                                    {% endif %}
                                </td>
                                <td class="prop-value">
                                    {{ tag.name }}
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </table>
            </div>
        {% endif %}
        <div class="rightpane">
            <hr />
            {% if votes.played_count == 0 %}
                <div class="prop-comment">
                    В эту игру никто не играл.
                </div>
            {% else %}
                <table>
                    <tr>
                        <td class="prop-category">
                            Рейтинг:
                        </td>
                        <td class="prop-value">
                            {% for x in votes.stars %}
                                <img src="/static/duck{{x}}.png" />
                            {% endfor %}
                            ({{ votes.avg_rating }})
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td class="prop-category">
                            ({{ votes.played_count|rupl:"оценка,оценки,оценок" }})
                        </td>
                    </tr>
                    <tr>
                        <td class="prop-category">
                            Среднее время игры:
                        </td>
                        <td class="prop-value">
                            {{ votes.played_hours|rupl:"час,часа,часов" }}
                            {{ votes.played_mins|rupl:"минута,минуты,минут" }}
                        </td>
                    </tr>
                    {% if votes.finished_count > 0 %}
                        <tr>
                            <td class="prop-category">
                                Время прохождения:
                            </td>
                            <td class="prop-value">
                                {{ votes.finished_hours|rupl:"час,часа,часов" }}
                                {{ votes.finished_mins|rupl:"минута,минуты,минут" }}
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td class="prop-category">
                                ({{ votes.finished_count|rupl:"человек,человека,человек" }})
                            </td>
                        </tr>
                    {% endif %}
                </table>
            {% endif %}
            {% if comment_perm %}
                {% if votes.user_played %}
                    {% comment %}
                        <div class="prop-comment">
                            (ваша оценка: {{ votes.user_score }},
                            {% if votes.user_finished %}
                                вы прошли игру за
                            {% else %}
                                вы играли в эту игру
                            {% endif %}
                            {{votes.user_hours}} ч.
                            {{votes.user_mins}} м.)
                        </div>
                    {% endcomment %}
                    <button id="voting_button">Изменить мой голос</button>
                {% else %}
                    {% if votes.played_count == 0 %}
                        <button id="voting_button">Я в это играло</button>
                    {% else %}
                        <button id="voting_button">Я в это тоже играло</button>
                    {% endif %}
                {% endif %}
                <form id="voting_form" style="display: none;" method="post"
                    action="{% url 'vote_game' %}">
                    <div class="prop-value">Оценка:</div>
                    <input type="radio" name="score" id="score1" value="1"
                    {% if votes.user_score == 1 %}checked{% endif %}
                    required/>
                    <label for="score1">
                        <img src="/static/duck10.png" />
                        <img src="/static/duck0.png" />
                        <img src="/static/duck0.png" />
                        <img src="/static/duck0.png" />
                        <img src="/static/duck0.png" />
                        &mdash; не понравилось
                    </label><br>
                    <input type="radio" name="score" id="score2" value="2"
                    {% if votes.user_score == 2 %}checked{% endif %}
                    required/>
                    <label for="score2">
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck0.png" />
                        <img src="/static/duck0.png" />
                        <img src="/static/duck0.png" />
                        &mdash; нормально
                    </label><br>
                    <input type="radio" name="score" id="score3" value="3"
                    {% if votes.user_score == 3 %}checked{% endif %}
                    required/>
                    <label for="score3">
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck0.png" />
                        <img src="/static/duck0.png" />
                        &mdash; понравилось
                    </label><br>
                    <input type="radio" name="score" id="score4" value="4"
                    {% if votes.user_score == 4 %}checked{% endif %}
                    required/>
                    <label for="score4">
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck0.png" />
                        &mdash; очень понравилось
                    </label><br>
                    <input type="radio" name="score" id="score5" value="5"
                    {% if votes.user_score == 5 %}checked{% endif %}
                    required/>
                    <label for="score5">
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        <img src="/static/duck10.png" />
                        &mdash; изумительная игра!
                    </label><br>
                    Я играло в эту игру<br>
                    <span class="vote-timeselect hours">0</span>
                    <span class="vote-timeselect hours">1</span>
                    <span class="vote-timeselect hours">2</span>
                    <span class="vote-timeselect hours">3</span>
                    <span class="vote-timeselect hours">4</span>
                    <span class="vote-timeselect hours">5</span>
                    <input id="hours" type="number" min="0" max="9999"
                    name="hours" value="{{votes.user_hours}}" required>
                    <script type="text/javascript">
                    $('.vote-timeselect.hours').click(function(event) {
                    $('#hours').val($(this).text());
                    })
                    </script>
                    часов и<br>
                    <span class="vote-timeselect minutes">0</span>
                    <span class="vote-timeselect minutes">5</span>
                    <span class="vote-timeselect minutes">10</span>
                    <span class="vote-timeselect minutes">15</span>
                    <span class="vote-timeselect minutes">20</span>
                    <span class="vote-timeselect minutes">30</span>
                    <span class="vote-timeselect minutes">45</span>
                    <input id="minutes" type="number" min="0" max="59"
                    name="minutes" value="{{votes.user_mins}}" required>
                    <script type="text/javascript">
                    $('.vote-timeselect.minutes').click(function(event) {
                    $('#minutes').val($(this).text());
                    })
                    </script>
                    минут.<br>
                    <input type="checkbox" name="finished" id="scoref"
                    {% if votes.user_finished %}checked{% endif %}/>
                    <label for="scoref">Я прошло эту игру до конца.</label>
                    <br><br><input type="submit" value="Отправить мой голос" />
                    {% csrf_token %}
                    <input type="hidden" name="game_id" value="{{ game.id }}" />
                </form>
                <script type="text/javascript">
                $('#voting_button').click(function() {
                $('#voting_button').hide();
                $('#voting_form').show();
                });
                </script>
            {% endif %}
        </div>
        {% if links %}
            <div class="rightpane">
                <hr>
                <table>
                    {% for link in links %}
                        {% for url in link.items %}
                            <tr>
                                <td class="prop-category">
                                    {% if forloop.first %}
                                        {{ link.category.title }}:
                                    {% endif %}
                                </td>
                                <td class="prop-value">
                                    <a {% if x.url.is_broken %}title="Битая ссылка!"{% endif %} href="{{ url.GetRemoteUrl }}">
                                        {% if x.url.is_broken %}
                                            <img src="{% static 'brokenlink.svg' %}"/>
                                        {% endif %}
                                        {{ url.description }}
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </table>
            </div>
        {% endif %}
        <div style="clear: both;"></div>
    </div>
</div>
{% endblock %}